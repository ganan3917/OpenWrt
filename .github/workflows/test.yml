name: LEDE è‡ªåŠ¨ç¼–è¯‘

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ + åŒ—äº¬æ—¶é—´å‡Œæ™¨3ç‚¹ï¼ˆUTCæ—¶é—´19ç‚¹ï¼‰
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 19 * * *'  # UTCæ—¶é—´19:00 = åŒ—äº¬æ—¶é—´03:00

jobs:
  build-lede:
    runs-on: ubuntu-22.04
    env:
      # é…ç½®ä»“åº“ä¿¡æ¯
      LEDE_REPO: https://github.com/coolsnowwolf/lede
      LEDE_BRANCH: master
      # è‡ªå®šä¹‰æ–‡ä»¶è·¯å¾„ï¼ˆä»“åº“æ ¹ç›®å½•ä¸‹çš„customæ–‡ä»¶å¤¹ï¼‰
      CUSTOM_CONFIG: custom/all.config  # é…ç½®æ–‡ä»¶æ›´åä¸ºall.config
      CUSTOM_FEEDS: custom/feeds.conf.default  # è‡ªå®šä¹‰feedsé…ç½®
      OUTPUT_PREFIX: lede-firmware
      # å›ºä»¶å›ºå®šä¿¡æ¯ï¼ˆå¯æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
      PLATFORM: x86-64
      KERNEL_VERSION: 6.12.49
      DEFAULT_IP: 192.168.1.1
      DEFAULT_PW: password

    steps:
      - name: æ£€æŸ¥ç¯å¢ƒ
        run: |
          echo "å½“å‰ç³»ç»Ÿ: $(lsb_release -d | cut -f2)"
          echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
          echo "å¯ç”¨å†…å­˜: $(free -h | awk '/Mem/ {print $2}')"

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib gettext git libncurses5-dev libssl-dev python3-distutils \
            rsync unzip zlib1g-dev file wget curl rename

      - name: ç”Ÿæˆæ—¶é—´æˆ³
        id: timestamp
        run: |
          echo "DATE=$(date +%Y%m%d)" >> $GITHUB_OUTPUT  # æ—¥æœŸï¼ˆå¦‚20241005ï¼‰
          echo "TIME=$(date +%H%M%S)" >> $GITHUB_OUTPUT  # æ—¶é—´ï¼ˆå¦‚030000ï¼‰

      - name: å…‹éš†LEDEæºç 
        run: |
          git clone --depth 1 -b $LEDE_BRANCH $LEDE_REPO lede
          cd lede
          # åˆå§‹åŒ–é»˜è®¤feedsï¼ˆåç»­è‹¥æœ‰è‡ªå®šä¹‰feedsä¼šè¦†ç›–ï¼‰
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: æ›¿æ¢è‡ªå®šä¹‰feedsé…ç½®
        run: |
          if [ -f "$GITHUB_WORKSPACE/$CUSTOM_FEEDS" ]; then
            echo "ğŸ”„ æ›¿æ¢ä¸ºè‡ªå®šä¹‰feeds.conf.default"
            cp -f "$GITHUB_WORKSPACE/$CUSTOM_FEEDS" lede/feeds.conf.default
            # é‡æ–°æ›´æ–°feedsï¼ˆåº”ç”¨è‡ªå®šä¹‰æºï¼‰
            cd lede
            ./scripts/feeds update -a
            ./scripts/feeds install -a
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰feedsæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          fi

      - name: æ›¿æ¢è‡ªå®šä¹‰all.configé…ç½®æ–‡ä»¶
        run: |
          if [ -f "$GITHUB_WORKSPACE/$CUSTOM_CONFIG" ]; then
            echo "ğŸ”„ æ›¿æ¢ä¸ºè‡ªå®šä¹‰all.config"
            # å°†custom/all.configå¤åˆ¶åˆ°æºç ç›®å½•å¹¶å‘½åä¸º.configï¼ˆLEDEç¼–è¯‘è¦æ±‚é…ç½®æ–‡ä»¶åä¸º.configï¼‰
            cp -f "$GITHUB_WORKSPACE/$CUSTOM_CONFIG" lede/.config
            # æ£€æŸ¥é…ç½®å¹¶è‡ªåŠ¨å®‰è£…ç¼ºå¤±ä¾èµ–
            cd lede
            make defconfig  # ç¡®ä¿é…ç½®ç”Ÿæ•ˆï¼ˆè‡ªåŠ¨å¤„ç†ä¾èµ–ï¼‰
          else
            echo "âŒ æœªæ‰¾åˆ°è‡ªå®šä¹‰all.configæ–‡ä»¶ï¼Œç¼–è¯‘ç»ˆæ­¢"
            exit 1  # å¿…é¡»æä¾›all.configï¼Œå¦åˆ™ç»ˆæ­¢ç¼–è¯‘
          fi
          # ä¿å­˜æœ€ç»ˆç”Ÿæ•ˆçš„é…ç½®ï¼ˆä¾¿äºæ ¸å¯¹ï¼Œå‘½åä¿ç•™all.configæ ‡è¯†ï¼‰
          cp lede/.config "$GITHUB_WORKSPACE/all-config-final-${{ steps.timestamp.outputs.DATE }}.txt"

      - name: å¼€å§‹ç¼–è¯‘
        run: |
          cd lede
          # ç¼–è¯‘çº¿ç¨‹æ•°ï¼ˆCPUæ ¸å¿ƒæ•°ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼‰
          threads=$(nproc)
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨$threadsçº¿ç¨‹"
          make -j$threads V=s  # V=s æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é”™è¯¯

      - name: æ•´ç†ç¼–è¯‘äº§ç‰©
        id: package
        run: |
          mkdir -p firmware
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶ï¼ˆ.bin/.img/.tar.gzï¼‰
          find lede/bin/targets/ -type f \( -name "*.bin" -o -name "*.img" -o -name "*.tar.gz" \) -exec cp {} firmware/ \;
          # é‡å‘½åäº§ç‰©ï¼ˆæ·»åŠ æ—¥æœŸæ ‡è¯†ï¼‰
          cd firmware
          for file in *; do
            newname="${{ env.OUTPUT_PREFIX }}-${{ steps.timestamp.outputs.DATE }}-${file}"
            mv "$file" "$newname"
            echo "ğŸ“¦ é‡å‘½å: $newname"
          done
          # æ‰“åŒ…æ‰€æœ‰å›ºä»¶
          cd ..
          tar -czvf "${{ env.OUTPUT_PREFIX }}-${{ steps.timestamp.outputs.DATE }}.tar.gz" firmware/
          echo "PACKAGE_NAME=${{ env.OUTPUT_PREFIX }}-${{ steps.timestamp.outputs.DATE }}.tar.gz" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ æœ€ç»ˆé…ç½®åˆ°Artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-build-config
          path: all-config-final-${{ steps.timestamp.outputs.DATE }}.txt
          retention-days: 7

      - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.timestamp.outputs.DATE }}
          name: LEDE ç¼–è¯‘äº§ç‰© ${{ steps.timestamp.outputs.DATE }}
          body: |
            ### LEDE è‡ªåŠ¨ç¼–è¯‘å›ºä»¶ï¼ˆ${{ steps.timestamp.outputs.DATE }}ï¼‰
            - ç¼–è¯‘æ—¶é—´: ${{ steps.timestamp.outputs.DATE }} ${{ steps.timestamp.outputs.TIME }}
            - é…ç½®æ–‡ä»¶: åŸºäºè‡ªå®šä¹‰all.configç¼–è¯‘

            ğŸ“’ å›ºä»¶ä¿¡æ¯
            ğŸ’» å¹³å°æ¶æ„: ${{ env.PLATFORM }}
            âš½ å›ºä»¶æºç : ${{ env.LEDE_REPO }}
            ğŸ’ æºç åˆ†æ”¯: ${{ env.LEDE_BRANCH }}
            ğŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
            ğŸŒ é»˜è®¤åœ°å€: ${{ env.DEFAULT_IP }}
            ğŸ”‘ é»˜è®¤å¯†ç : ${{ env.DEFAULT_PW }}
          files: ${{ steps.package.outputs.PACKAGE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.LEDE_ALL }}

      - name: æ¸…ç†æ—§Releasesï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
        run: |
          echo "${{ secrets.LEDE_ALL }}" | gh auth login --with-token
          repo=$(gh repo view --json nameWithOwner --jq .nameWithOwner)
          releases=$(gh api repos/$repo/releases | jq -r '.[] | .id')
          ids=($releases)
          if [ ${#ids[@]} -gt 5 ]; then
            echo "ğŸ§¹ æ¸…ç†æ—§Release"
            for ((i=5; i<${#ids[@]}; i++)); do
              gh api -X DELETE repos/$repo/releases/${ids[$i]}
            done
          fi
