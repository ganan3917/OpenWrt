name: LEDE 自动编译

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'  # 北京时间凌晨3点

jobs:
  build-lede:
    runs-on: ubuntu-22.04
    env:
      LEDE_REPO: https://github.com/coolsnowwolf/lede
      LEDE_BRANCH: master
      # 关键：使用绝对路径格式，明确从仓库根目录开始
      CUSTOM_CONFIG: ./custom/all.config  # 核心修改：添加./确保相对路径正确
      CUSTOM_FEEDS: ./custom/feeds.conf.default
      OUTPUT_PREFIX: lede-firmware
      PLATFORM: x86-64
      KERNEL_VERSION: 6.12.49
      DEFAULT_IP: 192.168.1.1
      DEFAULT_PW: password

    steps:
      - name: 检查环境
        run: |
          echo "当前工作目录: $(pwd)"
          echo "仓库根目录: $GITHUB_WORKSPACE"

      - name: 拉取仓库代码（包含custom文件夹）
        uses: actions/checkout@v4  # 关键步骤：拉取当前仓库所有文件

      - name: 安装依赖
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib gettext git libncurses5-dev libssl-dev python3-distutils \
            rsync unzip zlib1g-dev file wget curl rename

      - name: 生成时间戳
        id: timestamp
        run: |
          echo "DATE=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TIME=$(date +%H%M%S)" >> $GITHUB_OUTPUT

      - name: 克隆LEDE源码
        run: |
          git clone --depth 1 -b $LEDE_BRANCH $LEDE_REPO lede
          cd lede
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 替换自定义feeds配置
        run: |
          # 打印文件检查日志（用于调试）
          echo "检查feeds文件是否存在: $CUSTOM_FEEDS"
          ls -l ./custom || echo "custom文件夹不存在"
          if [ -f "$CUSTOM_FEEDS" ]; then
            echo "替换自定义feeds.conf.default"
            cp -f "$CUSTOM_FEEDS" lede/feeds.conf.default
            cd lede
            ./scripts/feeds update -a
            ./scripts/feeds install -a
          else
            echo "⚠️ 未找到自定义feeds文件，使用默认配置"
          fi

      - name: 替换自定义all.config配置文件
        run: |
          # 核心调试：打印路径和文件列表，确认文件是否存在
          echo "当前工作目录: $(pwd)"
          echo "预期的all.config路径: $CUSTOM_CONFIG"
          ls -l ./custom || echo "custom文件夹不存在"  # 列出custom文件夹内容
          ls -l "$CUSTOM_CONFIG" || echo "all.config文件不存在"  # 直接检查目标文件

          if [ -f "$CUSTOM_CONFIG" ]; then
            echo "替换为自定义all.config"
            cp -f "$CUSTOM_CONFIG" lede/.config  # 复制到源码目录并命名为.config
            cd lede
            make defconfig
          else
            echo "❌ 未找到自定义all.config文件，编译终止"
            exit 1
          fi
          cp lede/.config "$GITHUB_WORKSPACE/all-config-final-${{ steps.timestamp.outputs.DATE }}.txt"

      - name: 开始编译
        run: |
          cd lede
          threads=$(nproc)
          make -j$threads V=s

      - name: 整理编译产物
        id: package
        run: |
          mkdir -p firmware
          find lede/bin/targets/ -type f \( -name "*.bin" -o -name "*.img" -o -name "*.tar.gz" \) -exec cp {} firmware/ \;
          cd firmware
          for file in *; do
            newname="${{ env.OUTPUT_PREFIX }}-${{ steps.timestamp.outputs.DATE }}-${file}"
            mv "$file" "$newname"
          done
          cd ..
          tar -czvf "${{ env.OUTPUT_PREFIX }}-${{ steps.timestamp.outputs.DATE }}.tar.gz" firmware/
          echo "PACKAGE_NAME=${{ env.OUTPUT_PREFIX }}-${{ steps.timestamp.outputs.DATE }}.tar.gz" >> $GITHUB_OUTPUT

      - name: 上传最终配置到Artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-build-config
          path: all-config-final-${{ steps.timestamp.outputs.DATE }}.txt
          retention-days: 7

      - name: 上传固件到Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.timestamp.outputs.DATE }}
          name: LEDE 编译产物 ${{ steps.timestamp.outputs.DATE }}
          body: |
            ### LEDE 自动编译固件（${{ steps.timestamp.outputs.DATE }}）
            - 编译时间: ${{ steps.timestamp.outputs.DATE }} ${{ steps.timestamp.outputs.TIME }}
            - 配置文件: 基于自定义all.config编译

            📒 固件信息
            💻 平台架构: ${{ env.PLATFORM }}
            ⚽ 固件源码: ${{ env.LEDE_REPO }}
            💝 源码分支: ${{ env.LEDE_BRANCH }}
            🚀 内核版本: ${{ env.KERNEL_VERSION }}
            🌐 默认地址: ${{ env.DEFAULT_IP }}
            🔑 默认密码: ${{ env.DEFAULT_PW }}
          files: ${{ steps.package.outputs.PACKAGE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.LEDE_ALL }}

      - name: 清理旧Releases
        run: |
          echo "${{ secrets.LEDE_ALL }}" | gh auth login --with-token
          repo=$(gh repo view --json nameWithOwner --jq .nameWithOwner)
          releases=$(gh api repos/$repo/releases | jq -r '.[] | .id')
          ids=($releases)
          if [ ${#ids[@]} -gt 5 ]; then
            for ((i=5; i<${#ids[@]}; i++)); do
              gh api -X DELETE repos/$repo/releases/${ids[$i]}
            done
          fi
