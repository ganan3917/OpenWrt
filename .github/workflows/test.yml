name: LEDE è‡ªåŠ¨ç¼–è¯‘

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'  # åŒ—äº¬æ—¶é—´å‡Œæ™¨3ç‚¹

jobs:
  build-lede:
    runs-on: ubuntu-22.04
    env:
      LEDE_REPO: https://github.com/coolsnowwolf/lede
      LEDE_BRANCH: master
      # å…³é”®ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„æ ¼å¼ï¼Œæ˜ç¡®ä»ä»“åº“æ ¹ç›®å½•å¼€å§‹
      CUSTOM_CONFIG: ./custom/all.config  # æ ¸å¿ƒä¿®æ”¹ï¼šæ·»åŠ ./ç¡®ä¿ç›¸å¯¹è·¯å¾„æ­£ç¡®
      CUSTOM_FEEDS: ./custom/feeds.conf.default
      OUTPUT_PREFIX: lede-firmware
      PLATFORM: x86-64
      KERNEL_VERSION: 6.12.49
      DEFAULT_IP: 192.168.1.1
      DEFAULT_PW: password

    steps:
      - name: æ£€æŸ¥ç¯å¢ƒ
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ä»“åº“æ ¹ç›®å½•: $GITHUB_WORKSPACE"

      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆåŒ…å«customæ–‡ä»¶å¤¹ï¼‰
        uses: actions/checkout@v4  # å…³é”®æ­¥éª¤ï¼šæ‹‰å–å½“å‰ä»“åº“æ‰€æœ‰æ–‡ä»¶

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib gettext git libncurses5-dev libssl-dev python3-distutils \
            rsync unzip zlib1g-dev file wget curl rename

      - name: ç”Ÿæˆæ—¶é—´æˆ³
        id: timestamp
        run: |
          echo "DATE=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "TIME=$(date +%H%M%S)" >> $GITHUB_OUTPUT

      - name: å…‹éš†LEDEæºç 
        run: |
          git clone --depth 1 -b $LEDE_BRANCH $LEDE_REPO lede
          cd lede
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: æ›¿æ¢è‡ªå®šä¹‰feedsé…ç½®
        run: |
          # æ‰“å°æ–‡ä»¶æ£€æŸ¥æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "æ£€æŸ¥feedsæ–‡ä»¶æ˜¯å¦å­˜åœ¨: $CUSTOM_FEEDS"
          ls -l ./custom || echo "customæ–‡ä»¶å¤¹ä¸å­˜åœ¨"
          if [ -f "$CUSTOM_FEEDS" ]; then
            echo "æ›¿æ¢è‡ªå®šä¹‰feeds.conf.default"
            cp -f "$CUSTOM_FEEDS" lede/feeds.conf.default
            cd lede
            ./scripts/feeds update -a
            ./scripts/feeds install -a
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰feedsæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          fi

      - name: æ›¿æ¢è‡ªå®šä¹‰all.configé…ç½®æ–‡ä»¶
        run: |
          # æ ¸å¿ƒè°ƒè¯•ï¼šæ‰“å°è·¯å¾„å’Œæ–‡ä»¶åˆ—è¡¨ï¼Œç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "é¢„æœŸçš„all.configè·¯å¾„: $CUSTOM_CONFIG"
          ls -l ./custom || echo "customæ–‡ä»¶å¤¹ä¸å­˜åœ¨"  # åˆ—å‡ºcustomæ–‡ä»¶å¤¹å†…å®¹
          ls -l "$CUSTOM_CONFIG" || echo "all.configæ–‡ä»¶ä¸å­˜åœ¨"  # ç›´æ¥æ£€æŸ¥ç›®æ ‡æ–‡ä»¶

          if [ -f "$CUSTOM_CONFIG" ]; then
            echo "æ›¿æ¢ä¸ºè‡ªå®šä¹‰all.config"
            cp -f "$CUSTOM_CONFIG" lede/.config  # å¤åˆ¶åˆ°æºç ç›®å½•å¹¶å‘½åä¸º.config
            cd lede
            make defconfig
          else
            echo "âŒ æœªæ‰¾åˆ°è‡ªå®šä¹‰all.configæ–‡ä»¶ï¼Œç¼–è¯‘ç»ˆæ­¢"
            exit 1
          fi
          cp lede/.config "$GITHUB_WORKSPACE/all-config-final-${{ steps.timestamp.outputs.DATE }}.txt"

      - name: å¼€å§‹ç¼–è¯‘
        run: |
          cd lede
          threads=$(nproc)
          make -j$threads V=s

      - name: æ•´ç†ç¼–è¯‘äº§ç‰©
        id: package
        run: |
          mkdir -p firmware
          find lede/bin/targets/ -type f \( -name "*.bin" -o -name "*.img" -o -name "*.tar.gz" \) -exec cp {} firmware/ \;
          cd firmware
          for file in *; do
            newname="${{ env.OUTPUT_PREFIX }}-${{ steps.timestamp.outputs.DATE }}-${file}"
            mv "$file" "$newname"
          done
          cd ..
          tar -czvf "${{ env.OUTPUT_PREFIX }}-${{ steps.timestamp.outputs.DATE }}.tar.gz" firmware/
          echo "PACKAGE_NAME=${{ env.OUTPUT_PREFIX }}-${{ steps.timestamp.outputs.DATE }}.tar.gz" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ æœ€ç»ˆé…ç½®åˆ°Artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-build-config
          path: all-config-final-${{ steps.timestamp.outputs.DATE }}.txt
          retention-days: 7

      - name: ä¸Šä¼ å›ºä»¶åˆ°Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.timestamp.outputs.DATE }}
          name: LEDE ç¼–è¯‘äº§ç‰© ${{ steps.timestamp.outputs.DATE }}
          body: |
            ### LEDE è‡ªåŠ¨ç¼–è¯‘å›ºä»¶ï¼ˆ${{ steps.timestamp.outputs.DATE }}ï¼‰
            - ç¼–è¯‘æ—¶é—´: ${{ steps.timestamp.outputs.DATE }} ${{ steps.timestamp.outputs.TIME }}
            - é…ç½®æ–‡ä»¶: åŸºäºè‡ªå®šä¹‰all.configç¼–è¯‘

            ğŸ“’ å›ºä»¶ä¿¡æ¯
            ğŸ’» å¹³å°æ¶æ„: ${{ env.PLATFORM }}
            âš½ å›ºä»¶æºç : ${{ env.LEDE_REPO }}
            ğŸ’ æºç åˆ†æ”¯: ${{ env.LEDE_BRANCH }}
            ğŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
            ğŸŒ é»˜è®¤åœ°å€: ${{ env.DEFAULT_IP }}
            ğŸ”‘ é»˜è®¤å¯†ç : ${{ env.DEFAULT_PW }}
          files: ${{ steps.package.outputs.PACKAGE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.LEDE_ALL }}

      - name: æ¸…ç†æ—§Releases
        run: |
          echo "${{ secrets.LEDE_ALL }}" | gh auth login --with-token
          repo=$(gh repo view --json nameWithOwner --jq .nameWithOwner)
          releases=$(gh api repos/$repo/releases | jq -r '.[] | .id')
          ids=($releases)
          if [ ${#ids[@]} -gt 5 ]; then
            for ((i=5; i<${#ids[@]}; i++)); do
              gh api -X DELETE repos/$repo/releases/${ids[$i]}
            done
          fi
